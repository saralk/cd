<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Slab" rel="stylesheet">
        <style type='text/css'>
            h1, h2, h3, h4 {
                font-family: 'Roboto Slab', serif;
                text-align: center;
              
            }
          
            .lead {
                text-align: center;
                font-size: 18pt;
            }

            body {
                font-family: 'Lato', sans-serif;
            }
          
                        input {
                  width: 100%;
                  font-size: 18pt;
              }
          
                        #main {
                  width: 50%;
                  margin-left: 25%;
              }
          
                        .input-section {
                  margin-bottom: 15px;
                          font-size: 12pt;
              }
          
                            .result {
                  display: none;
                  border: 1px solid black;
                  padding: 5px;
                  text-align: center;
              }
        </style>
    </head>
    <body>

        <form id='main'>
            <h1>College Voters Will Save America From Trump</h1>
            <p class='lead'>College students can vote at home or at school. Which one is best for Democrats?</p>
              <div class='input-section'>
                  <label for='homeinput'>Home Address:</label>
                  <input type='text' id='homeinput' />
              </div>

              <div class='input-section'>
                  <label for='uniinput'>School Address:</label>
                  <input type='text' id='uniinput' />
              </div>
          
              <div class='result' id='vote-home'>
                  <h3>Vote at home!</h3>
                  <p>
                      Your parent's district is more competitive, so you're more likely to help Democrats there. They need you back home. Vote by mail.
                  </p>
              </div>
              <div class='result' id='vote-school'>
                  <h3>Vote at school!</h3>
                  <p>
                      Your school's district is more competitive, so you're more likely to help Democrats where. Welcome to your new home. Register and vote at school.
                  </p>
              </div>
              <div class='result' id='vote-tossup'>
                  <h3>Tied!</h3>
                  <p>
                      We think both districts are similarly competitive, so pick one and vote!
                  </p>
              </div>
        </form>

        <div id='results'></div>

        <script type='text/javascript'>
            var home, uni
            function initMap() {
                var options = {
                    componentRestrictions: {country: "us"}
                };

                home = new google.maps.places.SearchBox(document.getElementById('homeinput'), options);
                uni = new google.maps.places.SearchBox(document.getElementById('uniinput'), options);

                google.maps.event.addListener(home, 'places_changed', handleChange);
                google.maps.event.addListener(uni, 'places_changed', handleChange);
            }

            function handleChange() {
                var home_place = home.getPlaces();
                var uni_place = uni.getPlaces();
                
                var results_el = document.getElementById("results");
                
                if (home_place && uni_place) {
                    var home_coords = home_place[0].geometry.location;
                    var uni_coords = uni_place[0].geometry.location;

                    getPriorities(home_coords, uni_coords, function(response) {
                        var priorities = JSON.parse(response);
                        
                        renderResults(priorities);
                    });
                }
            }

            function getPriorities(home_c, uni_c, cb) {
                let home_coords = home_c.lat()+','+home_c.lng();
                let uni_coords = uni_c.lat()+','+uni_c.lng();
                var xmlHttp = new XMLHttpRequest();
                xmlHttp.onreadystatechange = function() { 
                    if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                        cb(xmlHttp.responseText);
                }
                xmlHttp.open("GET", '/priorities?home='+encodeURIComponent(home_coords)+'&uni='+encodeURIComponent(uni_coords), true);
                xmlHttp.send();
            }

              function renderResults(results) {
                  if (results.home.priority > results.uni.priority) {
                      document.getElementById('vote-school').style.display = 'none';
                      document.getElementById('vote-home').style.display = 'block';
                      document.getElementById('vote-tossup').style.display = 'none';
                  }
                  if (results.uni.priority > results.home.priority) {
                      document.getElementById('vote-home').style.display = 'none';
                      document.getElementById('vote-school').style.display = 'block';
                      document.getElementById('vote-tossup').style.display = 'none';
                  }
                  if (results.uni.priority == results.home.priority) {
                      document.getElementById('vote-home').style.display = 'none';
                      document.getElementById('vote-school').style.display = 'none';
                      document.getElementById('vote-tossup').style.display = 'block';
                  }
              }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyD9F6qk9NbkzES-gCLs0y1bIicsO3eI9bU&callback=initMap" async defer></script>
    </body>
</html>
